<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>SystemVerilog学习（四） - Wenhui&#39;s Rotten Pen</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="文辉" />
  <meta name="description" content="本文 SystemVerilog学习系列主要介绍SystemVerilog语言的基础知识，是验证工程师必须熟练掌握的语言基础。此为第四篇，主要" />

  <meta name="keywords" content="Hugo, linux, emacs, CPU" />






<meta name="generator" content="Hugo 0.58.3" />


<link rel="canonical" href="https://wenhui.space/post/digital_verifer/study_systemverilog_four/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.0995afa14b62cd93e93cfc066b646c4c17a3eddca0e9d52a1d9dcf5d90aaacd3.css" integrity="sha256-CZWvoUtizZPpPPwGa2RsTBej7dyg6dUqHZ3PXZCqrNM=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="SystemVerilog学习（四）" />
<meta property="og:description" content="本文 SystemVerilog学习系列主要介绍SystemVerilog语言的基础知识，是验证工程师必须熟练掌握的语言基础。此为第四篇，主要" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wenhui.space/post/digital_verifer/study_systemverilog_four/" />
<meta property="article:published_time" content="2020-01-20T22:17:00+08:00" />
<meta property="article:modified_time" content="2020-03-05T18:06:47+08:00" />
<meta itemprop="name" content="SystemVerilog学习（四）">
<meta itemprop="description" content="本文 SystemVerilog学习系列主要介绍SystemVerilog语言的基础知识，是验证工程师必须熟练掌握的语言基础。此为第四篇，主要">


<meta itemprop="datePublished" content="2020-01-20T22:17:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-03-05T18:06:47&#43;08:00" />
<meta itemprop="wordCount" content="5203">



<meta itemprop="keywords" content="SystemVerilog," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SystemVerilog学习（四）"/>
<meta name="twitter:description" content="本文 SystemVerilog学习系列主要介绍SystemVerilog语言的基础知识，是验证工程师必须熟练掌握的语言基础。此为第四篇，主要"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">文辉的烂笔头</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/about/">关于</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/links/">友链</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/index.xml">订阅</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css" integrity="sha256-LWdHSKWG7zv3DTpee8YAgoTfkj3gNkfauF624h4P2Nw=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css" integrity="sha256-Q9bBMw/rHRRag46GDWY84J3elDNc8JJjKXL9tIC4oe8=" crossorigin="anonymous" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      文辉的烂笔头
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/about/">关于</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/links/">友链</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://wenhui.space/index.xml">订阅</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">SystemVerilog学习（四）</h1>
      
      <div class="post-meta">
        <time datetime="2020-01-20" class="post-time">
          2020-01-20
        </time>
        <div class="post-category">
            <a href="https://wenhui.space/categories/%E8%8A%AF%E7%89%87%E9%AA%8C%E8%AF%81%E5%B7%A5%E7%A8%8B%E5%B8%88/"> 芯片验证工程师 </a>
            
          </div>
        <span class="more-meta"> 约 5203 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#本文">本文</a></li>
<li><a href="#参考">参考</a></li>
<li><a href="#概览">概览</a></li>
<li><a href="#随机约束和分布">随机约束和分布</a>
<ul>
<li><a href="#为什么需要随机">为什么需要随机？</a></li>
<li><a href="#为什么需要约束">为什么需要约束？</a></li>
<li><a href="#我们需要随机什么">我们需要随机什么？</a></li>
<li><a href="#声明随机变量的类">声明随机变量的类</a></li>
<li><a href="#什么是约束">什么是约束</a></li>
<li><a href="#权重分布">权重分布</a></li>
<li><a href="#集合成员和inside">集合成员和inside</a></li>
<li><a href="#条件约束">条件约束</a></li>
<li><a href="#双向约束">双向约束</a></li>
</ul></li>
<li><a href="#约束块控制">约束块控制</a>
<ul>
<li><a href="#打开或关闭约束">打开或关闭约束</a></li>
<li><a href="#内嵌约束">内嵌约束</a></li>
</ul></li>
<li><a href="#随机函数">随机函数</a>
<ul>
<li><a href="#pre-randomize-和-post-randomize">pre_randomize 和 post_randomize</a></li>
<li><a href="#系统随机数函数">系统随机数函数</a></li>
<li><a href="#随机化个别变量">随机化个别变量</a></li>
</ul></li>
<li><a href="#数组约束">数组约束</a>
<ul>
<li><a href="#约束数组的大小">约束数组的大小</a></li>
<li><a href="#约束数组的元素">约束数组的元素</a></li>
<li><a href="#产生唯一元素值的数组">产生唯一元素值的数组</a></li>
<li><a href="#随机化句柄数组">随机化句柄数组</a></li>
</ul></li>
<li><a href="#随机控制">随机控制</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="本文">本文</h2>

<p>SystemVerilog学习系列主要介绍SystemVerilog语言的基础知识，是验证工程师必须熟练掌握的语言基础。此为第四篇，主要介绍类随机约束和分布、约束块控制、随机函数、数组约束、随机控制。</p>

<table>
<thead>
<tr>
<th>版本</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>0.1</td>
<td>初版发布</td>
</tr>
</tbody>
</table>

<h2 id="参考">参考</h2>

<ul>
<li>《SystemVerilog验证》，也就是所谓的绿皮书</li>
<li>路科验证。</li>
</ul>

<h2 id="概览">概览</h2>

<p><center>
<img width="800" src="/image/digital-verifer/Study-SystemVerilog-Four.png">
<div style="color:darkorange;"> <b>  </b>  </div>
</center></p>

<h2 id="随机约束和分布">随机约束和分布</h2>

<h3 id="为什么需要随机">为什么需要随机？</h3>

<ul>
<li>芯片复杂度越来越高，在20年前定向测试已经无法满足验证的需求，而随机测试的比例逐渐提高。</li>
<li>定向测试能找到你认为可能存在的缺陷，而随机测试可以找到连你都没有想到的缺陷。</li>
<li>随机测试的环境要求比定向测试复杂，它需要激励、参考模型和在线比较。上百次的仿真不再需要人为参与，以此来提高验证效率。</li>
<li>随机测试相对于定向测试可以减少相当多的代码量，而产生的激励较定向测试也更多样。</li>
</ul>

<h3 id="为什么需要约束">为什么需要约束？</h3>

<ul>
<li>如果随机没有约束，产生有效激励的同时，还会产生大量的无效激励。</li>
<li>通过为随机添加约束，这种随机自由是一种合法的随机，产生有效的测试激励。</li>
<li>约束不是一成不变的，为了获取期望的测试范围或期待的数值范围，约束需要“变形”。</li>
<li>随机的对象不只是一个数据，而是有联系的变量集合。通常这些变量集合会被封装在一个数据类里，同时需要类中声明数据之间的约束关系。因此，约束之后要产生一个随机数据的“求解器”，即在满足数据本身和数据之间约束关系的随机数值解。</li>
<li>约束不但可以指定数据的取值范围，还可以指定各个数值的随机权重分布。</li>
</ul>

<h3 id="我们需要随机什么">我们需要随机什么？</h3>

<ul>
<li>器件配置： 通过寄存器和系统信号。</li>
<li>环境配置： 随机化环境，例如合理的时钟和外部反馈信号。</li>
<li>原始输入数据： 例如MCDF数据包的长度、带宽，数据间的顺序。</li>
<li>延时： 握手信号之间的时序关系，例如valid和ready，req和ack之间的时序关系。</li>
<li>协议异常： 如果反馈信号给出异常，那么设计是否可以保持后续数据处理的稳定性。</li>
</ul>

<h3 id="声明随机变量的类">声明随机变量的类</h3>

<ul>
<li>随机化是为了产生更多可能的驱动，我们倾向于将相关数据有机整理在一个类的同时，也用“rand”关键词来表明它的随机属性。</li>
<li>“randc”关键词表示周期性随机，即所有可能的值都赋过值后随机才可能重复，也就好比54张扑克牌抽牌游戏，rand代表每抽完一张放回去才可以下次抽牌，randc代表没抽完一张不需要放回就抽取下一张，如果抽完了，那就全部放回再次同样规则抽取。</li>
<li>rand和randc，只能声明类的变量，硬件域以及软件域的局部变量都不可以。</li>
<li>随机属性需要配合SV预定义的随机函数std::randomize()使用。即通过声明rand变量，并且在后期调用randomize()函数才可以随机化变量。</li>
<li>约束constraint也同随机变量一起在class中声明。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">packet</span><span class="p">;</span>
    <span class="n">rand</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mh">8</span><span class="p">];</span>
    <span class="n">randc</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">kind</span><span class="p">;</span>

    <span class="n">constraint</span> <span class="n">c</span> <span class="p">{</span>
        <span class="n">src</span> <span class="o">&gt;</span><span class="mh">10</span><span class="p">;</span>
        <span class="n">src</span> <span class="o">&lt;</span><span class="mh">15</span><span class="p">;</span>
    <span class="p">}</span>
<span class="n">endclass</span>

<span class="c1">//----------------------------------
</span><span class="c1"></span>
<span class="n">Packet</span> <span class="n">p</span><span class="p">;</span>
<span class="k">initial</span> <span class="k">begin</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">new</span><span class="p">();</span>
    <span class="c1">//assert语句保证randomize成功，否则会报fatal（如果约束冲突，如src&gt;15 and src&lt;10则会随机失败）
</span><span class="c1"></span>    <span class="n">assert</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">randomize</span><span class="p">())</span> <span class="k">else</span> <span class="n">$fatal</span><span class="p">(</span><span class="mh">0</span><span class="p">,</span> <span class="s">&#34;Packet::randomize failed&#34;</span><span class="p">);</span>
    <span class="n">transmit</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="什么是约束">什么是约束</h3>

<ul>
<li>约束表达式的求解是有SV的约束求解器自动完成的。</li>
<li>求解器能够选择满足约束的值，这个值是由SV的PRNG（伪随机数发生器）从一个初始值（seed）产生。只要改变种子的值，就可以改变CRT的行为。</li>
<li>SV标准定义了表达式的含义以及产生的合法值，但没有规定求解器计算约束的准确顺序。也就是，不同仿真器对于同一个约束类和种子求解出的数值可能不同。</li>
<li>什么可以被约束？SV只能随机化二值数据类型，但数据位可以是二值或四值的，所以无法随机出x值和z值，也无法随机出字符串。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">date</span><span class="p">;</span>
    <span class="n">rand</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">month</span><span class="p">;</span> <span class="c1">//note:
</span><span class="c1"></span>    <span class="n">rand</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">day</span><span class="p">;</span>
    <span class="n">rand</span> <span class="kt">int</span> <span class="n">year</span><span class="p">;</span>

    <span class="n">constraint</span> <span class="n">c_data</span> <span class="p">{</span>
        <span class="n">month</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1</span><span class="o">:</span><span class="mh">12</span><span class="p">]};</span>
        <span class="n">day</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1</span><span class="o">:</span><span class="mh">31</span><span class="p">]};</span>
        <span class="n">year</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">2010</span><span class="o">:</span><span class="mh">2030</span><span class="p">]};}</span>
    <span class="p">}</span>
<span class="n">endclass</span>
</code></pre></td></tr></table>
</div>
</div>
<p>请问：month=10，day=31，year=2020此组随机值可以产生吗？ 答案：不能，因为month的声明是3位，所以不可能出现数值10，这也是经常会犯的错误，当你约束数据时，一定要与声明数据的位数相匹配。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">stim</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">CONGEST_ADDR</span> <span class="o">=</span> <span class="mh">42</span><span class="p">;</span> <span class="c1">//声明常数
</span><span class="c1"></span>    <span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span><span class="n">READ</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">}</span> <span class="n">stim_e</span><span class="p">;</span>
    <span class="n">randc</span> <span class="n">stime_e</span> <span class="n">kind</span><span class="p">;</span>
    <span class="n">rand</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">len</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">;</span>
    <span class="kt">bit</span> <span class="n">congestion_test</span><span class="p">;</span>

    <span class="n">constraint</span> <span class="n">c_stim</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">&lt;</span> <span class="mh">1000</span><span class="p">;</span>
        <span class="n">len</span> <span class="o">&gt;</span> <span class="mh">0</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">congestion_test</span><span class="p">)</span> <span class="p">(</span>
            <span class="n">dst</span> <span class="n">inside</span> <span class="p">{[</span><span class="n">CONGEST_ADDR</span><span class="o">-</span><span class="mh">100</span><span class="o">:</span><span class="n">CONGEST_ADDR</span><span class="o">+</span><span class="mh">100</span><span class="p">]};</span>
            <span class="n">src</span> <span class="o">==</span> <span class="n">CONGEST_ADDR</span><span class="p">;</span>
        <span class="p">)</span> <span class="k">else</span> <span class="p">(</span>
            <span class="n">src</span> <span class="n">inside</span> <span class="p">{</span><span class="mh">0</span><span class="p">,</span> <span class="p">[</span><span class="mh">10</span><span class="o">:</span><span class="mh">20</span><span class="p">],</span> <span class="p">[</span><span class="mh">100</span><span class="o">:</span><span class="mh">200</span><span class="p">]};</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="n">endclass</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="权重分布">权重分布</h3>

<ul>
<li>关键词dist可以在约束中用来产生随机数值的权重分布，这样某些值的选取机会要大于其他值。</li>
<li>dist操作符带有一个值的列表以及相应的权重，中间用 := 或 :/ 分开。值和权重可以是常数，也可以是变量。</li>
<li>权重不要百分比表示，权重的和也不必是100。</li>
<li>:= 操作符表示值的范围内的每一个值的权重是相同的， :/ 操作符表示权重要平均分到范围内的每一个值。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">rand</span> <span class="kt">int</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">;</span>

<span class="n">constraint</span> <span class="n">c_dist</span> <span class="p">{</span>
    <span class="n">src</span> <span class="n">dist</span> <span class="p">{</span><span class="mh">0</span><span class="o">:=</span><span class="mh">40</span><span class="p">,</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">3</span><span class="p">]</span><span class="o">:=</span><span class="mh">60</span><span class="p">);}</span>
    <span class="c1">// src=1, weight=40/220
</span><span class="c1"></span>    <span class="c1">// src=2, weight=60/220
</span><span class="c1"></span>    <span class="c1">// src=3, weight=60/220
</span><span class="c1"></span>    <span class="c1">// src=4, weight=60/220
</span><span class="c1"></span>
    <span class="n">dst</span> <span class="n">dist</span> <span class="p">{</span><span class="mh">0</span><span class="o">:/</span><span class="mh">40</span><span class="p">,</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">3</span><span class="p">]</span><span class="o">:/</span><span class="mh">60</span><span class="p">);}</span>
    <span class="c1">// dst=1, weight=40/100
</span><span class="c1"></span>    <span class="c1">// dst=2, weight=20/100
</span><span class="c1"></span>    <span class="c1">// dst=3, weight=20/100
</span><span class="c1"></span>    <span class="c1">// dst=4, weight=20/100
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="集合成员和inside">集合成员和inside</h3>

<ul>
<li>inside是常见的约束运算符，表示变量属于某个值的集合，除非还存在其他约束 ，否则随机变量在集合里取值的概率是相等的（集合里也可以是变量）。</li>
<li>可以使用 $ 符指定最大或最小值。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">rand</span> <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
<span class="n">constraint</span> <span class="n">c_range</span><span class="p">{</span>
    <span class="n">c</span> <span class="n">inside</span> <span class="p">{[</span><span class="nl">lo:</span><span class="n">hi</span><span class="p">]};</span>
<span class="p">}</span>

<span class="c1">//-------------------------------
</span><span class="c1"></span>
<span class="n">rand</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">b</span><span class="p">;</span>
<span class="n">rand</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">e</span><span class="p">;</span>
<span class="n">constraint</span> <span class="n">c_range</span> <span class="p">{</span>
    <span class="n">b</span> <span class="n">inside</span> <span class="p">{[</span><span class="err">$</span><span class="o">:</span><span class="mh">4</span><span class="p">],</span> <span class="p">[</span><span class="mh">20</span><span class="o">:</span><span class="err">$</span><span class="p">]};</span>
    <span class="n">e</span> <span class="n">inside</span> <span class="p">{[</span><span class="err">$</span><span class="o">:</span><span class="mh">4</span><span class="p">],</span> <span class="p">[</span><span class="mh">20</span><span class="o">:</span><span class="err">$</span><span class="p">]};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="条件约束">条件约束</h3>

<ul>
<li>可以通过 -&gt; 或者 if-else来让一个约束表达式在特定条件有效。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">constraint</span> <span class="n">c_io</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">i_space_mode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">addr</span><span class="p">[</span><span class="mh">31</span><span class="p">]</span> <span class="o">==</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span> <span class="c1">//i_space_mode!=0
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">//--------------------------------------
</span><span class="c1"></span>
<span class="n">constraint</span> <span class="n">c_io</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i_space_mode</span><span class="p">)</span> <span class="c1">//i_space_mode!=0
</span><span class="c1"></span>        <span class="n">addr</span><span class="p">[</span><span class="mh">31</span><span class="p">]</span> <span class="o">==</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
    <span class="k">else</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="双向约束">双向约束</h3>

<ul>
<li>约束块不是自上而下的程序代码，它们是声明性代码，是并行的，所有的约束同时有效。</li>
<li>约束是双向的，这表示它会同时计算所有的随机变量的约束，增加或删除任何一个变量的约束都会直接或间接的影响所有相关的值的选取。</li>
<li>约束块可以声明多个，但是它们仍旧是并行的，如果对同一变量进行约束，取两者约束的交集，也就是两个约束都会生效，与写在一个约束块效果相同。</li>
<li>子类会继承父类的约束。</li>
</ul>

<h2 id="约束块控制">约束块控制</h2>

<h3 id="打开或关闭约束">打开或关闭约束</h3>

<ul>
<li>一个类可以包含多个约束块，可以把不同约束块用于不同测试。</li>
<li>一般情况下，各个约束块之间的约束内容是相互协调不违背的，因此通过随机函数产生的随机数可以找到合适的解。</li>
<li>对于其他情况，例如跟胡不同需求，来选择使能哪些约束块，禁止哪些约束块，可以使用内建函数constraint_mode()打开或者关闭约束。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">packet</span><span class="p">;</span>
    <span class="n">rand</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
    <span class="n">constraint</span> <span class="n">c_short</span> <span class="p">{</span><span class="n">length</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1</span><span class="o">:</span><span class="mh">32</span><span class="p">];}}</span>
    <span class="n">constraint</span> <span class="n">c_long</span> <span class="p">{</span><span class="n">length</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1000</span><span class="o">:</span><span class="mh">1032</span><span class="p">];}}</span>
<span class="n">endclass</span>

<span class="c1">//------------------------
</span><span class="c1"></span>
<span class="n">packet</span> <span class="n">p</span><span class="p">;</span>
<span class="k">initial</span> <span class="k">begin</span>
    <span class="n">p</span> <span class="o">=</span><span class="n">new</span> <span class="p">();</span>
    <span class="c1">//create a long packet by disabling c_short
</span><span class="c1"></span>    <span class="n">p</span><span class="p">.</span><span class="n">c_short</span><span class="p">.</span><span class="n">constraint_mode</span><span class="p">(</span><span class="mh">0</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">randomize</span><span class="p">());</span>
    <span class="n">transmit</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="c1">//create a short packet by disabling all constraint and then enable only c_short
</span><span class="c1"></span>    <span class="n">p</span><span class="p">.</span><span class="n">constraint_mode</span><span class="p">(</span><span class="mh">0</span><span class="p">);</span>
    <span class="n">p</span><span class="p">.</span><span class="n">c_short</span><span class="p">.</span><span class="n">constraint_mode</span><span class="p">(</span><span class="mh">1</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">randomize</span><span class="p">());</span>
    <span class="n">transmit</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="内嵌约束">内嵌约束</h3>

<ul>
<li>伴随着复杂的约束，它们之间会相互作用，最终产生难以预测的结果。用来使能和禁止这些约束的代码也会增加测试的复杂性。</li>
<li>经常增加或修改类的约束也可能会影响整个团队的工作，这需要考虑类的OCP原则（开放封闭原则，也就是哪些对外部开放，哪些不对外开放）。</li>
<li>SV允许使用 randomize() with来增加额外的约束，这和在类里增加约束是等效的，但同时要注意类内部约束和外部约束之间应该是协调的，如果出现违背，随机数会求解失败（求解失败，不同的工具报告形式不同，有的是error，有的是warning）。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">packet</span><span class="p">;</span>
    <span class="n">rand</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
    <span class="n">constraint</span> <span class="n">c_short</span> <span class="p">{</span><span class="n">soft</span> <span class="n">length</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1</span><span class="o">:</span><span class="mh">32</span><span class="p">];}}</span>
<span class="n">endclass</span>

<span class="c1">//------------------------
</span><span class="c1"></span>
<span class="n">packet</span> <span class="n">p</span><span class="p">;</span>
<span class="k">initial</span> <span class="k">begin</span>
    <span class="n">p</span> <span class="o">=</span><span class="n">new</span> <span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">randomize</span><span class="p">()</span> <span class="n">with</span> <span class="p">{</span>
        <span class="n">length</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">36</span><span class="o">:</span><span class="mh">46</span><span class="p">];};</span>
        <span class="n">length</span> <span class="o">!=</span> <span class="mh">40</span><span class="p">;</span>         <span class="p">}</span>
    <span class="p">);</span>
    <span class="n">transmit</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div>
<p>上述例子中randomize() with{}约束与c_short产生可冲突，那会不会报错呢？答案是不会，因为c_short约束前加了soft（软约束）关键字，意义就在于当外部或子类的约束发生冲突时，其优先级降低，不会影响外部或子类的约束。</p>

<h2 id="随机函数">随机函数</h2>

<h3 id="pre-randomize-和-post-randomize">pre_randomize 和 post_randomize</h3>

<ul>
<li>有时需要在调用randomize()之前或之后立即执行一些操作，例如在随机前设置一些非随机变量（上下限、条件值、权重）,或者在随机化后需要计算数据的误差、分析和记录随机数据等。</li>
<li>SV提供两个预定义的void类型函数pre_randomize和post_randomize，用户可以类中定义这两个函数，分别在其中定义随机化前的行为和随机化后的行为。</li>
<li>如果某个类中定义了pre_randomize或post_randomize，那么对象在执行randomize()之前或之后会分别执行这两个函数，所以pre_randomize和post_randomize可以看做是randomize函数的回调函数（callback function）。</li>
</ul>

<h3 id="系统随机数函数">系统随机数函数</h3>

<p>SV提供了一些常用的系统随机函数，这些系统随机函数可以直接调用来返回随机数值：</p>

<ul>
<li>$random()平均分布，返回32位有符号随机数。</li>
<li>$urandom()平均分布，返回32位无符号随机数。</li>
<li>$urandom_range()在指定范围内的平均分布。</li>
</ul>

<h3 id="随机化个别变量">随机化个别变量</h3>

<ul>
<li>在调用randomize()时可以传递变量的一个子集，这样只会随机化类里的几个变量。</li>
<li>只有参数列表里的变量才会被随机化，其他变量会被当做状态量而不会被随机化。</li>
<li>所有的约束仍然保持有效。</li>
<li>注意：类里所有没有被指定rand的变量也可以作为randomize()的参数而被随机化。</li>
<li>注意：未进行随机化的变量默认初始值为0。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">rising</span><span class="p">;</span>
    <span class="kt">byte</span> <span class="n">low</span><span class="p">;</span>
    <span class="n">rand</span> <span class="kt">byte</span> <span class="n">med</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
    <span class="n">constraint</span> <span class="n">up</span> <span class="p">{</span>
        <span class="n">low</span><span class="o">&lt;</span><span class="n">med</span><span class="p">;</span> <span class="n">med</span><span class="o">&lt;</span><span class="n">hi</span><span class="p">;</span>
    <span class="p">}</span>
<span class="n">endclass</span>

<span class="c1">//----------------------------------
</span><span class="c1"></span>
<span class="k">initial</span> <span class="k">begin</span>
    <span class="n">rising</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span><span class="n">new</span><span class="p">();</span>
    <span class="n">r</span><span class="p">.</span><span class="n">randomize</span><span class="p">();</span> <span class="c1">//随机化hi和med，不改变low
</span><span class="c1"></span>    <span class="n">r</span><span class="p">.</span><span class="n">randomize</span><span class="p">(</span><span class="n">med</span><span class="p">);</span> <span class="c1">//只随机化med
</span><span class="c1"></span>    <span class="n">r</span><span class="p">.</span><span class="n">randomize</span><span class="p">(</span><span class="n">low</span><span class="p">);</span> <span class="c1">//只随机化low
</span><span class="c1"></span><span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="数组约束">数组约束</h2>

<h3 id="约束数组的大小">约束数组的大小</h3>

<ul>
<li>在约束随机标量的同时，我们也可以对随机化数组进行约束。</li>
<li>多数情况下，数组的大小应该给定范围，防止生成过大体积的数组或空数组。</li>
<li>此外，还可以在约束中结合数组的其他方法sum(), product(), and(), or(), 和xor()。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">dyn_size</span><span class="p">;</span>
    <span class="n">rand</span> <span class="kt">logic</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">d</span><span class="p">[];</span>
    <span class="n">constraint</span> <span class="n">d_size</span> <span class="p">{</span>
        <span class="n">d</span><span class="p">,</span><span class="n">size</span><span class="p">()</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1</span><span class="o">:</span><span class="mh">10</span><span class="p">];};</span>
    <span class="p">}</span>
<span class="n">endclass</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="约束数组的元素">约束数组的元素</h3>

<ul>
<li>SV可以利用foreach对数组每一个元素进行约束，和直接写出对固定大小数组的每一个元素相比，foreach更简洁。</li>
<li>针对动态数组，foreach更适合于对非固定大小数组中每个元素的约束。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">good_sum5</span><span class="p">;</span>
    <span class="n">rand</span> <span class="n">uint</span> <span class="n">len</span><span class="p">[];</span>
    <span class="n">constraint</span> <span class="n">c_len</span><span class="p">{</span>
        <span class="n">foreach</span> <span class="p">(</span><span class="n">len</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1</span><span class="o">:</span><span class="mh">255</span><span class="p">]};</span>
        <span class="n">len</span><span class="p">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mh">1024</span><span class="p">;</span>
        <span class="n">len</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1</span><span class="o">:</span><span class="mh">8</span><span class="p">]};</span>
    <span class="p">}</span>
<span class="n">endclass</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="产生唯一元素值的数组">产生唯一元素值的数组</h3>

<ul>
<li>如果想要产生一个随机数组，它的每一个元素值都是唯一的，如果使用randc数组，嘛呢数组中的每一个元素只会独立的随机化，并不会按照我们期望的使得数组中的元素值是唯一的。</li>
<li>解决方案1：</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">rand</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">data</span><span class="p">;</span>
<span class="n">constraint</span> <span class="n">c_data</span><span class="p">{</span>
    <span class="n">foreach</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">foreach</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>解决方案2：</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">class</span> <span class="n">randc_data</span><span class="p">;</span>
    <span class="n">randc</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">data</span><span class="p">[</span><span class="mh">64</span><span class="p">];</span>
<span class="n">endclass</span>

<span class="n">class</span> <span class="n">data_array</span><span class="p">;</span>
    <span class="kt">bit</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">data_array</span> <span class="p">[</span><span class="mh">64</span><span class="p">];</span>

    <span class="k">function</span> <span class="k">void</span> <span class="n">pre_randomize</span><span class="p">();</span>
        <span class="n">randc_data</span> <span class="n">rcd</span><span class="p">;</span>
        <span class="n">rcd</span> <span class="o">=</span> <span class="n">new</span><span class="p">();</span>
        <span class="n">foreach</span> <span class="p">(</span><span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">begin</span>
            <span class="n">assert</span><span class="p">(</span><span class="n">rcd</span><span class="p">.</span><span class="n">randomize</span><span class="p">());</span>
            <span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcd</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">endfunction</span>
<span class="n">endclass</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>特别示例如下，首先“&lt;=”代表小于等于，其次限定da.size为（3/4/5），实际不可能取到5，原因是da.size的约束体现在“da[i] &lt;= da[i+1]”时，约束的是i和i+1为为（3/4/5）。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="n">rand</span> <span class="kt">bit</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">da</span><span class="p">[];</span>
<span class="n">constraint</span> <span class="n">c_da</span> <span class="p">{</span>
    <span class="n">da</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">3</span><span class="o">:</span><span class="mh">5</span><span class="p">]};</span>
    <span class="n">foreach</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">da</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">da</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="随机化句柄数组">随机化句柄数组</h3>

<ul>
<li>随机句柄数组的功能是在调用其所在类的随机函数时，随机函数会随机化数组中的每一个句柄所指向的对象。因此随机句柄数组的声明一定要添加rand来表示其随机化的属性，同时在调用随机函数前要保证句柄数组中的每一个句柄元素都是非悬空的，这需要早随机化之前为每一个元素句柄构建对象。</li>
<li>如果要产生多个随机对象，那么你可能需要建立随机句柄数组。和整数数组不同，你需要在随机化前分配所有的元素，因为在随机求解器不会创建对象。使用动态数组可以按照需要分配最大数量的元素，然后再使用约束减小数组的大小。在随机化时，动态句柄数组的大小可以保持不变或减小，但不能增加。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="k">parameter</span> <span class="n">MAX_SIZE</span> <span class="o">=</span> <span class="mh">10</span><span class="p">;</span>
<span class="n">class</span> <span class="n">RandStuff</span><span class="p">;</span>
    <span class="kt">bit</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">value</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="n">endclass</span>

<span class="n">class</span> <span class="n">RandArray</span><span class="p">;</span>
    <span class="n">rand</span> <span class="n">RandStuff</span> <span class="n">array</span><span class="p">[];</span>
    <span class="n">constraint</span> <span class="n">c_array</span> <span class="p">{</span>
        <span class="n">array</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="n">inside</span> <span class="p">{[</span><span class="mh">1</span><span class="o">:</span><span class="n">MAX_SIZE</span><span class="p">]};</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">new</span><span class="p">();</span>
        <span class="c1">//分配最大容量
</span><span class="c1"></span>        <span class="n">array</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">];</span>
        <span class="n">foreach</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">();</span>
    <span class="k">endfunction</span>
<span class="n">endclass</span>

<span class="c1">//---------------------------
</span><span class="c1"></span>
<span class="n">RandArray</span> <span class="n">ra</span><span class="p">;</span>
<span class="k">initial</span> <span class="k">begin</span>
    <span class="c1">// 构造数组和所有对象
</span><span class="c1"></span>    <span class="n">ra</span> <span class="o">=</span> <span class="n">new</span><span class="p">();</span>
    <span class="c1">// 随机化数组，但可能会减小数组
</span><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">ra</span><span class="p">.</span><span class="n">randomize</span><span class="p">());</span>
    <span class="n">foreach</span><span class="p">(</span><span class="n">ra</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="nb">$display</span><span class="p">(</span><span class="n">ra</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>问题1：执行ra.randomize() with {array.size=2}时，array[0].value 和 array[0].value分别是多少？ 答案都是1，首先value没有加rand，所以randomize不会随机value，仍然保持为1。</li>
<li>问题2：为什么要分配最大容量？ 答案是只有创建对象，并且分配最大容量，才能保证随机化时可能会碰到句柄数组悬空，无指向对象，随机会报错。</li>
<li>总结：句柄数组的随机，首先查看句柄指向的对象内有没有rand变量，其次对句柄数组按最大容量进行例化。</li>
</ul>

<h2 id="随机控制">随机控制</h2>

<ul>
<li>产生事务序列的另一个方法是使用SV的randsequence结构。这对于随机安排组织原子（atomic）测试序列很有帮助。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="k">initial</span> <span class="k">begin</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="k">begin</span>
        <span class="n">randsequence</span> <span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="nl">stream:</span> <span class="n">cfg_read</span> <span class="o">:=</span> <span class="mh">1</span> <span class="o">|</span> <span class="c1">//权重不一样
</span><span class="c1"></span>                    <span class="n">io_read</span> <span class="o">:=</span> <span class="mh">2</span>  <span class="o">|</span> <span class="c1">//权重不一样
</span><span class="c1"></span>                    <span class="n">mem_read</span> <span class="o">:=</span> <span class="mh">5</span><span class="p">;</span> <span class="c1">//权重不一样
</span><span class="c1"></span>            <span class="nl">cfg_read:</span> <span class="p">(</span><span class="n">cfg_read_task</span><span class="p">;)</span> <span class="o">|</span>
                      <span class="p">(</span><span class="n">cfg_read_task</span><span class="p">;)</span> <span class="n">cfg_read</span><span class="p">;</span>
            <span class="nl">mem_read:</span> <span class="p">(</span><span class="n">mem_read_task</span><span class="p">;)</span> <span class="o">|</span>
                      <span class="p">(</span><span class="n">mem_read_task</span><span class="p">;)</span> <span class="n">mem_read</span><span class="p">;</span>
            <span class="nl">io_read:</span> <span class="p">(</span><span class="n">io_read_task</span><span class="p">;)</span> <span class="o">|</span>
                     <span class="p">(</span><span class="n">io_read_task</span><span class="p">;)</span> <span class="n">io_read</span><span class="p">;</span>
        <span class="n">endsequence</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>我们也可以使用randcase来建立随机决策树，但它带来的问题是没有变量可供追踪调试。</li>
</ul>

<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-verilog" data-lang="verilog"><span class="k">initial</span> <span class="k">begin</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
    <span class="nl">randcase:</span>
        <span class="mh">1</span><span class="o">:</span> <span class="n">len</span> <span class="o">=</span> <span class="n">$urandom_range</span><span class="p">(</span><span class="mh">0</span><span class="p">,</span><span class="mh">2</span><span class="p">);</span> <span class="c1">//10%
</span><span class="c1"></span>        <span class="mh">8</span><span class="o">:</span> <span class="n">len</span> <span class="o">=</span> <span class="n">$urandom_range</span><span class="p">(</span><span class="mh">3</span><span class="p">,</span><span class="mh">5</span><span class="p">);</span> <span class="c1">//80%
</span><span class="c1"></span>        <span class="mh">1</span><span class="o">:</span> <span class="n">len</span> <span class="o">=</span> <span class="n">$urandom_range</span><span class="p">(</span><span class="mh">6</span><span class="p">,</span><span class="mh">7</span><span class="p">);</span> <span class="c1">//10%
</span><span class="c1"></span>    <span class="k">endcase</span>
    <span class="nb">$display</span><span class="p">(</span><span class="s">&#34;len=%0d&#34;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>总结：

<ul>
<li>randsequence和randcase是针对轻量级的随机控制的应用。而我们可以通过定义随机类取代上述随机控制的功能，并且由于类的继承性使得后期维护代码时更加方便。</li>
<li>randsequence的相关功能我们在协调激励组件和测试用例时，可能会用到。</li>
<li>randcase则对应着随机约束中的dist权重约束 + if-else条件约束的组合。</li>
</ul></li>
</ul>

<hr />

<p><strong><em>文章原创，可能存在部分错误，欢迎指正，联系邮箱 cao_arvin@163.com。</em></strong></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">文辉</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2020-03-05
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">文辉原创文章，如需转载请注明出处，谢谢！！！</span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://wenhui.space/tags/systemverilog/">SystemVerilog</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/about_linux/python_tutorial/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Python简明教程</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/digital_verifer/beginner_verification_four/">
            <span class="next-text nav-default">初识芯片验证（四）</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  


 
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2019 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        文辉
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.bootcss.com/slideout/1.0.1/slideout.min.js" crossorigin="anonymous"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script src="/js/load-photoswipe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc="
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk="
      crossorigin="anonymous"></script>
  















</body>
</html>
